## 4. 通讯报文设计

本项目中通讯报文全部以`Hex`格式进行发送，与`Text`格式相比能至少节约一半的包大小，降低通讯压力与丢包概率，从而在高频通信时能够获得更好的性能表现。

### 4.1 状态报文

状态报文主要用于在上下位机之间更新、同步状态信息。主要依靠报文大小来区分不同类型的状态报文。

#### 4.1.1 Face_Full报文

**大小：36字节**

由于`FaceString`的长度为288，超过了UDP协议256个字节的传输上限，因而需要对齐进行一次压缩。因为原本脸字符串表示的是二进制数，因而简单的压缩方式就是将其压缩为十六进制数。压缩完后的Face_Full报文大小为36个字节，为脸字符串的八分之一。

举例: `0x00000000000000c00c30030c00c30030000000000000003f000840012000300000000000`

#### 4.1.2 Face_Lite报文

**大小：4字节**

在高速变换表情时为了降低通讯压力提升性能，针对单纯的由表情模块组合成的表情可以使用更简单的报文。每个表情模块的Id占用一个字节，这样只需要使用4个字节就可以表示整个表情，大小占用为正常Face_Full报文的九分之一。

举例：`0x04050600`，对应的表情模块id为左眼104，右眼204，嘴巴306，脸颊400。

#### 4.1.3 Color报文

**大小：3字节**

十六进制格式的RGB颜色。通过颜色数据`Color`编码而来，也可以解码为颜色数据。

举例: `0xf971d4`

#### 4.1.4 Bright报文

**长度：1字节**

十六进制的亮度值。通过亮度数据`Bright`编码而来，也可以解码为亮度数据。

举例: `0x80`

### 4.2 请求报文

由于下位机不会主动向上位机发送状态报文，因而需要上位机先发起一个请求。下位机收到请求报文后，再给上位机返回对应的状态报文。请求报文的长度均为**2字节**，需要完全匹配来区分。

#### 4.2.1 Face请求报文

**匹配: `0x1001`**

上位机向下位机发起脸字符串`FaceString`同步请求，下位机将当前LED颜色编码为Face_Full报文发回上位机。

#### 4.2.2 Color请求报文

**匹配: `0x1002`**

上位机向下位机发起颜色数据`Color`同步请求，下位机将当前LED颜色编码为Color报文发回上位机。

#### 4.2.3 Bright请求报文

**匹配: `0x1003`**

上位机向下位机发起亮度数据`Bright`同步请求，下位机将当前LED颜色编码为Bright报文发回上位机。

#### 4.2.4 Version请求报文

**匹配: `0x1003`**

上位机向下位机发起固件版本同步请求，下位机将当前固件版本发回上位机。

#### 4.2.4 Battery请求报文

**匹配: `0x1005`**

上位机向下位机发起电池电压同步请求，下位机将当前电池电压发回上位机。